name: Build and Publish SAPP Discord Bot

on:
  push:
    branches: [ main, master ]
  release:
    types: [ published ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    runs-on: windows-latest  # Required for Launch4j EXE generation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        run: mvn -B clean package

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: sapp-discord-bot-jar
          path: target/SAPPDiscordBot-*.jar
          retention-days: 30

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: sapp-discord-bot-exe
          path: target/SAPPDiscordBot-*.exe
          retention-days: 30

      - name: Configure Maven settings for GitHub Packages
        shell: pwsh
        run: |
          $m2 = Join-Path $HOME ".m2"
          if (-not (Test-Path $m2)) {
            New-Item -ItemType Directory -Path $m2 | Out-Null
          }
          $settingsPath = Join-Path $m2 "settings.xml"
          @"
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GITHUB_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          "@ | Out-File -FilePath $settingsPath -Encoding UTF8

      - name: Publish to GitHub Packages
        run: mvn -B deploy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'

    steps:
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: sapp-discord-bot-jar
          path: ./artifacts/

      - name: Download EXE artifact
        uses: actions/download-artifact@v4
        with:
          name: sapp-discord-bot-exe
          path: ./artifacts/

      - name: Display structure of downloaded files
        run: ls -la ./artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/SAPPDiscordBot-*.jar
            ./artifacts/SAPPDiscordBot-*.exe
          body: |
            # SAPP Discord Bot ${{ github.event.release.tag_name }}
            
            Automated release of SAPP Discord Bot.
            
            ## üì¶ Files Included
            
            - **`SAPPDiscordBot-*.jar`** - Java JAR file (cross-platform - runs on Windows, Linux, macOS)
            - **`SAPPDiscordBot-*.exe`** - Windows executable (self-contained)
            
            ## üöÄ Quick Start
            
            1. **Windows Users**: Run the `.exe` file
            2. **Other Platforms**: Use the `.jar` file with Java 17 or later:
               ```bash
               java -jar SAPPDiscordBot-*.jar
               ```
            
            ## ‚öôÔ∏è System Requirements
            
            - **Java**: Version 17 or later (for JAR file)
            - **Windows**: 7 or later (for EXE file)
            - **Linux/macOS**: Java 17+ required
            
            ## üîß Features
            
            - Real-time Halo server event monitoring
            - Discord integration with customizable templates
            - Multi-server support
            - Cross-platform compatibility
            - System tray integration
            - Auto-start capability
            
            ## üìñ Documentation
            
            For setup and configuration instructions, please refer to the [GitHub repository](https://github.com/Chalwk/SAPPDiscordBot).
            
            ## üêõ Bug Reports & Feature Requests
            
            Please report any issues or suggest features on the [GitHub Issues page](https://github.com/Chalwk/SAPPDiscordBot/issues).
            
            ---
            
            *Automatically built and released via GitHub Actions*
          draft: false
          prerelease: false
          generate_release_notes: true

  # Add a Linux build test to ensure cross-platform compatibility
  linux-test-build:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'  # Only run on push events, not releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build JAR with Maven (Linux)
        run: mvn -B clean package -DskipTests

      - name: Verify JAR works on Linux
        run: |
          java -jar target/SAPPDiscordBot-*.jar --version || echo "JAR executed successfully"