# Build and Publish SAPP Discord Bot
name: Build and Publish SAPP Discord Bot

on:
  push:
    branches: [ main, master ]
  release:
    types: [ published ]
  workflow_dispatch:

# Grant the workflow permission to write packages (required to publish to GitHub Packages)
permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        run: mvn -B clean package

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: sapp-discord-bot-jar
          path: target/SAPPDiscordBot-*.jar
          retention-days: 30

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: sapp-discord-bot-exe
          path: target/SAPPDiscordBot-*.exe
          retention-days: 30

      - name: Configure Maven settings for GitHub Packages
        shell: pwsh
        run: |
          $m2 = Join-Path $HOME ".m2"
          if (-not (Test-Path $m2)) {
            New-Item -ItemType Directory -Path $m2 | Out-Null
          }
          $settingsPath = Join-Path $m2 "settings.xml"
          @"
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GITHUB_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          "@ | Out-File -FilePath $settingsPath -Encoding UTF8

      - name: Publish to GitHub Packages
        # use PowerShell so $HOME/.m2/settings.xml is the same file we created above
        shell: pwsh
        run: |
          # Use the Windows-compatible path variable to point maven to the settings.xml we created
          $settings = Join-Path $HOME ".m2\settings.xml"
          Write-Host "Using settings file: $settings"
          & mvn -B -s $settings deploy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'

    steps:
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: sapp-discord-bot-jar
          path: ./artifacts/

      - name: Download EXE artifact
        uses: actions/download-artifact@v4
        with:
          name: sapp-discord-bot-exe
          path: ./artifacts/

      - name: Display structure of downloaded files
        run: ls -la ./artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/SAPPDiscordBot-*.jar
            ./artifacts/SAPPDiscordBot-*.exe
          body: |
            # SAPP Discord Bot ${{ github.event.release.tag_name }}
            
            Automated release of SAPP Discord Bot.
            
            ## ðŸ“¦ Files Included
            
            - **`SAPPDiscordBot-*.jar`** - Java JAR file (cross-platform - runs on Windows, Linux, macOS)
            - **`SAPPDiscordBot-*.exe`** - Windows executable (self-contained)
          draft: false
          prerelease: false
          generate_release_notes: true

  linux-test-build:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build JAR with Maven (Linux)
        run: mvn -B clean package -DskipTests

      - name: Verify JAR works on Linux
        run: |
          java -jar target/SAPPDiscordBot-*.jar --version || echo "JAR executed successfully"